---
export const prerender = true;

import Sidebar from "./SideBar.astro";
import MobileSideBar from "./MobileSideBar.tsx";
import type { UserSubscription } from "../types";
import { getSession } from "auth-astro/server";
import {
    fetchUserBlogsWithSubscriptionStatus,
    fetchAllBlogs,
} from "../../../aws/backend/db/query";

const session = await getSession(Astro.request);
const userEmail = session?.user?.email ? session.user.email : "";

async function fetchBlogs() {
    return userEmail !== ""
        ? await fetchUserBlogsWithSubscriptionStatus(userEmail)
        : await fetchAllBlogs();
}

const subs = (await fetchBlogs()) as UserSubscription[];

// Sort by subscribed
subs.sort((a, b) =>
    a.subscribed === b.subscribed ? 0 : a.subscribed ? -1 : 1,
);

const comingSoonEntry = {
    blogId: 1000,
    blogLink: "/",
    companyName: "More coming soon!",
    subscribed: false,
};

subs.push(comingSoonEntry);
---

<div class="dark:text-black">
    <Sidebar session={session} userEmail={userEmail} subs={subs} />
    <MobileSideBar
        client:load
        session={session}
        userEmail={userEmail}
        subs={subs}
    />
</div>
